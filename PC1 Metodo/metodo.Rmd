---
title: 'EcoAnimal USP, Prática de Computador I: Método Científico'
author: "Marco A. R. Mello"
output: html_notebook
runtime: shiny
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(inline = function(x) {
prettyNum(x, big.mark=",")
})
```

Para entender o contexto deste tutorial e creditar seus autores, leia o
[README](https://github.com/marmello77/EcoAnimal/blob/main/README.md).

## Atenção!

Siga à risca as instruções dadas a seguir. Qualquer desvio delas pode
acarretar em problemas técnicos que nos farão perder tempo em sala
desnecessariamente. Leia tudo com muita atenção e faça a prática sem
pressa.

## Cabeçalho

Escreva na caixinha abaixo os nomes completos dos integrantes do seu
grupo, junto com os respectivos números USP. Inclua também a data da
prática.

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Nomes + NUSP:

Data:
:::

## Instruções gerais

1.  Mude o modo de vizualização aqui no RStudio para `Visual`, clicando
    no botão que fica no canto esquerdo da barra de formatação;

2.  Clique no triângulo verde da primeira caixinha de código (dentro
    dela, no alto à direita), logo acima desta seção;

3.  Leia atentamente este roteiro e faça a prática junto com o seu
    grupo;

4.  Tente fazer a prática sem a ajuda dos docentes. Caso não consiga,
    peça-nos ajuda;

5.  No relatório a ser entregue, adicione um cabeçalho com os nomes
    completos dos integrantes do grupo, incluindo seus números USP e a
    data da prática;

6.  O relatório deve ser entregue através da tarefa criada no moodle da
    disciplina, no formato pedido;

7.  Não serão aceitos relatórios entregues fora do prazo determinado.

## **Objetivo**

Para aprender como se faz ciência ou mesmo para entender mais a fundo
artigos científicos, é fundamental saber como funciona o método
científico. Assim, esta aula prática visa complementar a aula teórica,
proporcionando uma oportunidade de consolidar os conhecimentos
aprendidos além de adquirir novas habilidades. Aqui, faremos a dissecção
do artigo de base e ainda aprenderemos como desenhar um mapa mental por
programação.

## Artigo de base

[Muchhala (2006, Nature)](https://doi.org/10.1038/444701a)

## **Passos iniciais**

1.  Releia o artigo de base com atenção, mais de uma vez, se preciso;

2.  Identifique no texto os seguintes *elementos do método científico*:
    **problema**, **pergunta**, **hipótese**, **premissas**,
    **previsões** e **conclusão**. Descreva-os no contexto do artigo de
    base sucintamente, usando frases curtas. Anote essas descrições nas
    caixinhas abaixo:

### Problema

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

### Pergunta

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

### Hipótese

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

### Premissas

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

### Previsões

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

### Conclusão

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```

::: answer-box
Escreva sua resposta aqui.
:::

## Passos intermediários

1.  Pense sobre como esses elementos se relacionam entre si, com base no
    que foi ensinado na aula teórica;

2.  Organize essas descrições curtas na forma de um esboço de mapa
    mental, feito à mão ou no computador;

3.  Siga os próximos passos para aprender como desenhar a versão final
    do seu mapa mental por programação, em linguagem R.

## Desenhando o mapa mental

Diga ao `RStudio` que o diretório de trabalho é o mesmo onde está este
arquivo de tutorial. Para executar as linhas de código desta e das
demais caixinhas do tutorial, clique no triângulo verde da caixinha de
código desejada, no alto à direita

```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

Limpe os objetos criados anteriormente:

```{r}
rm(list= ls())

```

Limpe o console:

```{r}
cat("\014")  

```

Agora desenhe o mapa mental usando uma interface gráfica:

```{r}
library(shiny)
library(igraph)
library(visNetwork)
library(ggplot2)
library(ggraph)

ui <- fluidPage(
  titlePanel("Mapa Mental Interativo"),
  
  sidebarLayout(
    sidebarPanel(
      actionButton("add_node", "Adicionar Novo Nó"),
      
      uiOutput("nodes_ui"),  # Interface dinâmica para rótulos dos nós
      
      actionButton("add_edge", "Adicionar Conexão"),
      
      uiOutput("edges_ui"),  # Interface dinâmica para conexões
      
      actionButton("gerar", "Gerar Mapa Mental"),
      
      downloadButton("save_map", "Salvar como PNG (300 DPI)")  # Botão para salvar o mapa
    ),
    
    mainPanel(
      visNetworkOutput("mapa", height = "600px"),  # Mapa mental interativo
      
      h3("Detalhes do Nó Selecionado:"),
      textOutput("node_details")  # Exibe detalhes do nó clicado
    )
  )
)

server <- function(input, output, session) {
  # Inicializa com os rótulos padrão
  initial_labels <- c("Problema", "Pergunta", "Hipótese", "Premissa 1", "Premissa 2")
  nodes_list <- reactiveVal(data.frame(id = 1:5, label = initial_labels, stringsAsFactors = FALSE))
  edges_list <- reactiveVal(data.frame(from = numeric(), to = numeric(), stringsAsFactors = FALSE))
  
  # Adiciona novo nó
  observeEvent(input$add_node, {
    current_nodes <- nodes_list()
    new_id <- nrow(current_nodes) + 1
    new_node <- data.frame(id = new_id, label = paste("Nó", new_id), stringsAsFactors = FALSE)
    nodes_list(rbind(current_nodes, new_node))
  })
  
  # Atualiza a interface dinâmica para entrada dos rótulos dos nós
  output$nodes_ui <- renderUI({
    nodes <- nodes_list()
    tagList(
      lapply(1:nrow(nodes), function(i) {
        textInput(paste0("node_", nodes$id[i]), label = paste("Rótulo do Nó", nodes$id[i]), value = nodes$label[i])
      })
    )
  })
  
  # Atualiza interface dinâmica de conexões
  observeEvent(input$add_edge, {
    num_edges <- nrow(edges_list()) + 1
    insertUI(
      selector = "#add_edge",
      where = "beforeBegin",
      ui = tagList(
        selectInput(paste0("from_", num_edges), "De:", choices = nodes_list()$id),
        selectInput(paste0("to_", num_edges), "Para:", choices = nodes_list()$id)
      )
    )
  })
  
  # Gera o mapa mental com rótulos recuperados das caixas de input
  observeEvent(input$gerar, {
    # Atualiza os rótulos dos nós a partir dos inputs antes de construir o mapa
    nodes <- nodes_list()
    for (i in 1:nrow(nodes)) {
      input_label <- input[[paste0("node_", nodes$id[i])]]
      if (!is.null(input_label) && input_label != "") {
        nodes$label[i] <- input_label
      }
    }
    nodes_list(nodes)  # Salva a atualização dos rótulos
    
    # Atualiza conexões sem duplicação
    new_edges_data <- data.frame(from = numeric(), to = numeric(), stringsAsFactors = FALSE)
    num_edges <- length(grep("^from_", names(input)))  # Conta quantas conexões foram criadas
    for (i in 1:num_edges) {
      from_input <- input[[paste0("from_", i)]]
      to_input <- input[[paste0("to_", i)]]
      
      if (!is.null(from_input) && !is.null(to_input) && from_input != to_input) {
        new_edge <- data.frame(from = as.numeric(from_input), to = as.numeric(to_input), stringsAsFactors = FALSE)
        
        # Evita duplicatas
        existing_edges <- edges_list()
        if (!any(existing_edges$from == new_edge$from & existing_edges$to == new_edge$to)) {
          edges_list(rbind(existing_edges, new_edge))
        }
      }
    }
    
    # Gera o mapa mental
    output$mapa <- renderVisNetwork({
      visNetwork(nodes_list(), edges_list()) %>%
        visNodes(shape = "box") %>%
        visEdges(arrows = "to") %>%
        visPhysics(enabled = TRUE) %>%
        visInteraction(dragNodes = TRUE, dragView = TRUE, zoomView = TRUE) %>%
        visEvents(selectNode = "function(nodes) { 
          Shiny.setInputValue('selected_node', nodes.nodes[0], {priority: 'event'});
        }")
    })
  })
  
  # Exibir detalhes do nó selecionado
  output$node_details <- renderText({
    selected_id <- input$selected_node
    nodes <- nodes_list()
    
    if (!is.null(selected_id)) {
      selected_node <- nodes[nodes$id == selected_id, ]
      paste("ID:", selected_node$id, "- Rótulo:", selected_node$label)
    } else {
      "Clique em um nó para ver os detalhes."
    }
  })
  
  # Salvar o mapa mental como PNG com 300 DPI
  output$save_map <- downloadHandler(
    filename = function() { "mapa_mental.png" },
    content = function(file) {
      nodes <- nodes_list()
      edges <- edges_list()
      
      if (nrow(nodes) > 0) {
        graph <- graph_from_data_frame(edges, vertices = nodes, directed = TRUE)
        
        # Criando um plot com ggplot2 e ggraph
        p <- ggraph(graph, layout = "stress") +
          geom_edge_link(arrow = arrow(length = unit(4, 'mm')), end_cap = circle(3, 'mm'), color = "gray50") +
          geom_node_point(size = 5, color = "blue") +
          geom_node_text(aes(label = label), repel = TRUE, size = 6) +
          theme_void()
        
        # Salvando a imagem com 300 DPI
        ggsave(file, plot = p, width = 10, height = 7, dpi = 300)
      }
    }
  )
}

shinyApp(ui, server)

```

## Passos finais

1.  Exporte este notebook com suas respostas em formato HTML (também
    pode ser DOC ou PDF, se o seu computador permitir). Na barra de
    ferramentas da aba deste notebook, clique em "Knit\>Knit to HTML";

2.  Carregue este notebook respondido no link do moodle para entrega do
    relatório.

## Para saber mais

1.  [Mapa mental: organizando as suas
    ideias](https://marcoarmello.wordpress.com/2015/04/15/mapasmentais/)

2.  [O que é uma
    teoria?](https://marcoarmello.wordpress.com/2012/03/13/teoria/)

3.  [Operacionalizando uma
    hipótese](https://marcoarmello.wordpress.com/2012/03/13/operacionalizando/)
