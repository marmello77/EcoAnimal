---
title: 'EcoAnimal USP, Prática de Computador II: Reprodução'
author: "Marco A. R. Mello"
output:
  html_document:
    df_print: paged
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(inline = function(x) {
prettyNum(x, big.mark=",")
})
```

Para entender o contexto deste tutorial e creditar seus autores, leia o
[README](https://github.com/marmello77/EcoAnimal/blob/main/README.md).

## Instruções gerais

1.  Mude o modo de vizualização aqui no RStudio para `Visual`, clicando
    no botão que fica no canto esquerdo da barra de formatação;

2.  Clique no triângulo verde da primeira caixinha de código (dentro
    dela, no alto à direita), logo acima desta seção;

3.  Leia atentamente este roteiro e faça a prática junto com o seu
    grupo;

4.  Tente fazer a prática sem a ajuda dos docentes. Caso não consiga,
    peça-nos ajuda;

5.  No relatório a ser entregue, adicione um cabeçalho com os nomes
    completos dos integrantes do grupo, incluindo seus números USP e a
    data da prática;

6.  O relatório deve ser entregue através da tarefa criada no moodle da
    disciplina, no formato pedido;

7.  Não serão aceitos relatórios entregues fora do prazo determinado.

## Artigo de base

[Palaoro et al. (2014 Animal
Behaviour)](http://dx.doi.org/10.1016/j.anbehav.2014.06.014)

## Agradecimentos

[Alexandre Palaoro](https://github.com/alexandrepalaoro), primeiro autor
do artigo de referência, gentilmente nos cedeu os dados usados nesta
prática.

## Objetivo

Um dos fenômenos mais importantes relacionados à reprodução animal é a
seleção sexual. Nesta prática, treinaremos como testar hipóteses
concorrentes à luz das evidências disponíveis, usando a abordagem
conhecida como inferência forte.

## Contexto

Nosso objeto de estudo são interações agonísticas entre machos de uma
mesma espécie. Essas interações visam resolver disputas por recursos,
sejam fêmeas, território ou alimento. A disputa pode envolver confronto
indireto, quando os machos avaliam as características um do outro e um
deles desiste antes mesmo de lutar. Ou pode envolver confronto direto,
quando os machos chegam às vias de fato, entrando em luta corporal.
Essas lutas não costumam levar a danos sérios ou à morte, pois é comum
um dos machos desistir depois de avaliar suas chances de vencer e o que
ele tem a perder. Para entender os mecanismos que determinam os
resultados dessas lutas, usaremos como modelo de estudo caranguejos da
espécie *Aegla longirostri*. Os dados foram analisados em um artigo
científico (Palaoro et al. 2014, Animal Behaviour), cujo primeiro autor
gentilmente nos cedeu a planilha.

## Passos iniciais

1.  Assista ao [vídeo da
    luta](https://edisciplinas.usp.br/mod/hvp/view.php?id=5081849) entre
    caranguejos disponível no moodle. Eles pertencem ao mesmo gênero
    daqueles usados como modelo de estudo no artigo de base;

2.  Veja a figura 1 abaixo, que apresenta informações importantes sobre
    a morfologia dos caranguejos estudados no artigo de base.

### Figura 1

Representação de um macho da espécie de caranguejo Aegla longirostri
adaptado de (Bond-Buckup 2003, apud Palaoro et al. 2014). A linha preta
representa o comprimento do cefalotórax. (b) Representação esquemática
da garra esquerda. LE: comprimento da garra; CH: altura da garra; (1):
altura do dedo; (2): distância do fulcro ao primeiro tubérculo; (3):
apodema

![](imagens/Figura%201.png){width="311" height="491"}

## Preparativos

Diga ao `RStudio` que o diretório de trabalho é o mesmo onde está este
arquivo de tutorial. Para executar as linhas de código desta e das
demais caixinhas do tutorial, clique no triângulo verde da caixinha de
código desejada, no alto à direita

```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

Limpe os objetos criados anteriormente e também o console:

```{r}
rm(list= ls())

```

Limpe o console:

```{r}
cat("\014")  

```

Carregue os pacotes necessários:

```{r}
library(ggplot2)
library(lme4)
```

## Passos intermediários

1.  Examine os dados e metadados da planilha XLSX fornecida;

2.  Qual dessas medidas fornecidas na planilha você acha que deve ser
    mais importante para prever quem ganhará uma luta entre dois
    caranguejos machos dessa espécie?

3.  Descreva de maneira sucinta os elementos do método científico que
    sustentam a sua expectativa: **problema**, **pergunta**,
    **hipótese**, **premissas** e **previsão**. Use as técnicas
    aprendidas nas aulas anteriores. Você pode trabalhar com múltiplas
    hipóteses e previsões, se quiser.

### Problema

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

### Pergunta

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

### Hipótese

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

### Premissas

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

### Previsões

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

## Mapa mental

Agora é hora de organizar os elementos do método científico na forma de
um mapa mental. Faça um esboço desse mapa à mão ou num programa de
slides. Depois faça a versão final por programação.

Aqui vai um mapa mental básico para você começar a programar.
Modifique-o da forma que achar melhor

```{r}
library(DiagrammeR)

mapa <- create_graph()

mapa <- add_node(mapa, label = "Problema",
                  type = "problema",
                  node_aes = node_aes(shape = "rectangle",
                                      height = 0.9,
                                      width = 0.9,
                                      fontsize = 8,
                                      fillcolor = c("white"),
                                      color = c("red")))
mapa <- add_node(mapa, label = "Pergunta", 
                  type = "pergunta",
                  node_aes = node_aes(shape = "triangle",
                                      height = 0.7,
                                      width = 0.7,
                                      fontsize = 5,
                                      fillcolor = c("white"),
                                      color = c("blue")))
mapa <- add_node(mapa, label = "Premissa 1", 
                  type = "premissa",
                  node_aes = node_aes(shape = "plaintext",
                                      fontsize = 5,
                                      color = c("white"),
                                      fillcolor = c("white")))
mapa <- add_node(mapa, label = "Premissa 2", 
                  type = "premissa",
                  node_aes = node_aes(shape = "plaintext",
                                      fontsize = 5,
                                      color = c("white"),
                                      fillcolor = c("white")))
mapa <- add_node(mapa, label = "Hipótese 1",
                  type = "hipotese",
                  node_aes = node_aes(shape = "ellipse",
                                      fontsize = 5,
                                      fillcolor = c("white"),
                                      color = c("darkgreen")))

mapa <- add_node(mapa, label = "Previsão 1",
                  type = "previsao",
                  node_aes = node_aes(shape = "polygon",
                                      sides = 5,
                                      fontsize = 5,
                                      color = c("yellow4"),
                                      fillcolor = c("white")))


mapa <- add_edge(mapa, "Problema", "Pergunta", edge_aes = NULL, edge_data = NULL)
mapa <- add_edge(mapa, "Pergunta", "Hipótese 1", edge_aes = NULL, edge_data = NULL)
mapa <- add_edge(mapa, "Premissa 1", "Hipótese 1", edge_aes = NULL, edge_data = NULL)
mapa <- add_edge(mapa, "Premissa 2", "Hipótese 1", edge_aes = NULL, edge_data = NULL)
mapa <- add_edge(mapa, "Hipótese 1", "Previsão 1", edge_aes = NULL, edge_data = NULL)
```

Visualize o mapa:

```{r}
render_graph(mapa)
```

Exporte o mapa como uma figura, quando ele estiver pronto:

```{r}
export_graph(mapa, file_name = "figuras/mapa_mental.png",
             file_type = "png",
             width = 3000,
             height = 3000)

```

## Analisando visualmente

Importe os dados e dê uma boa olhada na estrutura deles. Quais são as
variáveis e quais são as observações?

```{r}
dados<- read.delim("dados.txt", header=T) #importando um arquivo TXT
dim(dados)
head(dados)
tail(dados)
```

No primeiro resultado, vemos as dimensões do quadro de dados (*data*
*frame*) em linhas x colunas.

No segundo resultado, vemos as seis primeiras linhas do quadro de dados.

No terceiro resultado, vemos as seis últimas linhas do quadro de dados.

Agora, transforme a variável `status` em numérica e binária, salvando-a
como uma nova variável:

```{r}
dados$status2 <- ifelse(dados$status == "perdedor", 0, 1) #teste lógico
head(dados)
```

Examine de forma preliminar as relações entre as variáveis disponíveis:

```{r}
plot(dados$cc~dados$ap)
plot(dados$status2~dados$cc)
plot(dados$status2~dados$ap)
```

Você conhece esses tipos de gráficos?

O primeiro gráfico é um **diagrama de dispersão de pontos**, também
conhecido como gráfico de regressão ou gráfico de correlação. Ele mostra
a relação entre duas variáveis numéricas e contínuas.

Através desse tipo de gráfico, você pode analisar visualmente se, quando
uma variável aumenta, a outra aumenta ou diminui (i.e., relação positiva
ou negativa), ou ainda se elas não apresentam relação alguma entre si.

### Pergunta 1

No caso dos dados do **primeiro gráfico**, você nota alguma relação
entre o comprimento cefalotorácico (`cc`) e a altura do própodo (`ap`)?
Por que?

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

### Pergunta 2

Você pode também analisar visualmente a força de uma eventual relação
positiva ou negativa entre as variáveis e o tamanho do efeito. Basta
checar o quanto os pontos estão dispersos ou concentrados ao redor de
uma reta de tendência hipotética. Caso haja alguma relação, você acha
que ela é forte ou fraca e por que?

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

O segundo e o terceiro são **gráficos logísticos**. Eles mostram a
relação entre uma variável numérica e contínua, o **fator**, e uma
variável numérica e binária (do tipo "sim ou não"), a **resposta**.

Através desse tipo de gráfico, você pode analisar visualmente a
probabilidade de a resposta ser 0 ou 1, conforme aumenta o fator. O
ponto 0.5 no eixo Y representa o limiar da transição de uma resposta
para a outra. Essa relação entre fator e resposta também pode ser
positiva ou negativa.

### Pergunta 3

Você lembra o que representam 0 e 1 na variável que transformamos lá
atrás (`status2`)?

Considerando o **segundo gráfico**, você acha que a chance de um
caranguejo vencer uma luta depende ou não da variável escolhida como
fator? Se depende, a chance aumenta ou diminui? Por que?

```{=html}
<style>
.answer-box {
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
```
::: answer-box
Escreva sua resposta aqui.
:::

## Melhorando um dos gráficos

Que tal produzir um gráfico mais completo?

Vamos calcular uma linha de tendência, rodando um GLM com distribuição
binomial:

```{r}
fit1 = glm(dados$status2~dados$cc, family=binomial)
summary(fit1)
```

E agora vamos adicionar essa linha de tendência ao gráfico:

```{r}
plot(dados$status2~dados$cc,
     xlab = "Comprimento do corpo",
     ylab = "Status")
curve (exp(fit1$coefficients[[1]]+fit1$coefficients[[2]]*x)/
         (1+exp(fit1$coefficients[[1]]+fit1$coefficients[[2]]*x)),
       add=T)
```

Podemos expotar o gráfico como uma figura:

```{r}
png("figuras/p1b.png", width = 1000, height = 700)
plot(dados$status2~dados$cc,
     xlab = "Comprimento do corpo",
     ylab = "Status")
curve (exp(fit1$coefficients[[1]]+fit1$coefficients[[2]]*x)/
         (1+exp(fit1$coefficients[[1]]+fit1$coefficients[[2]]*x)),
       add=T)
dev.off()  

```

## O seu gráfico {#teste2}

OK, agora que você já viu o básico sobre como fazer os tipos de gráficos
de que precisamos, que tal fazer o gráfico que você realmente tinha
planejado desde o começo, com as variáveis que você acha que importam?

Pode copiar, colar e adaptar na caixinha abaixo os códigos de que
precisa:

```{r}

```

Exporte o seu gráfico como uma figura:

```{r}

```

## Passos finais

1.  Pegue o seu mapa mental exportado e cole-o em um novo arquivo de um
    programa de slides ou gráfico;

2.  Complete o seu mapa mental, colando perto da previsão o gráfico que
    representa seu respectivo teste. Se tiver trabalhado com mais de uma
    previsão, terá feito mais de um gráfico;

3.  Diga se a sua previsão se confirmou ou não, apenas com base no
    gráfico;

4.  Inclua uma conclusão geral sucinta no seu mapa;

5.  Exporte o seu mapa mental em formato PDF e carregue-o no link do
    moodle para entregar o relatório.

## Para saber mais

[Qual gráfico devo
fazer?](https://marcoarmello.wordpress.com/2020/05/29/qualgrafico/)

[Tidy Data Manifesto](https://vita.had.co.nz/papers/tidy-data.html)

[Regressão logística na
Wikipedia](https://en.wikipedia.org/wiki/Logistic_regression)

[GLM na
Wikipedia](https://en.wikipedia.org/wiki/Generalized_linear_model)
